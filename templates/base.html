<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopLore</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/ShopLore logo.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="/">
                <img src="{{ url_for('static', filename='images/ShopLore logo.png') }}" alt="ShopLore Logo" width="40" height="40" class="me-2 rounded-circle shadow-sm" style="object-fit:cover;">
                ShopLore
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    {% if jwt_user %}
                        {% if jwt_user['role'] == 'delivery' %}
                            <!-- Delivery: Only show profile/logout -->
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="/features">Features</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/cart">Cart</a>
                            </li>
                        {% endif %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="profile-circle me-2">
                                    <img src="https://ui-avatars.com/api/?name={{ jwt_user['username'] }}&background=0D8ABC&color=fff&rounded=true&size=32" alt="Profile" class="rounded-circle" width="32" height="32">
                                </span>
                                {{ jwt_user['username'] }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                                <li><a class="dropdown-item" href="/profile">Profile</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/logout">Logout</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="/login">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/register">Register</a>
                        </li>
                        <!-- <li class="nav-item">
                            <a class="nav-link" href="/cart">Cart</a>
                        </li> -->
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    {% if not jwt_user %}
    <header class="bg-light py-5 mb-4 position-relative">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3 animate__animated animate__fadeInDown">Get Groceries Delivered in Minutes!</h1>
            <p class="lead animate__animated animate__fadeInUp">Fast, fresh, and at your doorstep. Experience the future of quick delivery with <span class="fw-bold text-success">ShopLore</span>.</p>
            <a href="/register" class="btn btn-primary btn-lg mt-3 animate__animated animate__pulse animate__infinite">Get Started</a>
        </div>
        <!-- Animated SVG wave for hero -->
        <svg class="position-absolute w-100" style="bottom:0; left:0; z-index:1;" height="80" viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#e0f7fa" d="M0,32L48,42.7C96,53,192,75,288,74.7C384,75,480,53,576,37.3C672,21,768,11,864,21.3C960,32,1056,64,1152,74.7C1248,85,1344,75,1392,69.3L1440,64L1440,80L1392,80C1344,80,1248,80,1152,80C1056,80,960,80,864,80C768,80,672,80,576,80C480,80,384,80,288,80C192,80,96,80,48,80L0,80Z"></path></svg>
    </header>
    {% endif %}
    {% if jwt_user %}
    <div class="container mt-4">
        <form class="row justify-content-center mb-4" method="get" action="/">
            <div class="col-md-8 col-lg-6">
                <div class="input-group input-group-lg shadow-sm">
                    <input type="text" class="form-control rounded-start-pill" name="q" placeholder="Search for products (e.g. banana, milk, chips)" value="{{ request.args.get('q', '') }}">
                    <button class="btn btn-primary rounded-end-pill px-4" type="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                            <path d="M11 6a5 5 0 1 1-10 0 5 5 0 0 1 10 0zm-1.293 6.707a6 6 0 1 0-1.414 1.414l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.85-3.85z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </form>
    </div>
    {% endif %}
    <main class="container position-relative">
        {% block content %}{% endblock %}
        {% if show_products_section|default(true) and jwt_user and jwt_user['role'] != 'delivery' %}
        <h2 class="mt-3 mb-4 text-center animate__animated animate__fadeIn">Available Products</h2>
        <div class="row row-cols-1 row-cols-md-3 g-4 mb-5">
            {% for product in products %}
            <div class="col">
                <div class="card h-100 shadow-sm animate__animated animate__zoomIn">
                    {% if product.image_url %}
                    <img src="{{ product.image_url }}" class="card-img-top" alt="{{ product.name }}" style="object-fit:cover; height:200px;">
                    {% else %}
                    <img src="https://via.placeholder.com/300x200?text=No+Image" class="card-img-top" alt="No Image" style="object-fit:cover; height:200px;">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text">{{ product.description }}</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <span class="fw-bold">â‚¹{{ product.price }}</span>
                        <button class="btn btn-success btn-sm add-to-cart-btn" data-product='{{ product | tojson | safe }}'>Add to Cart</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- Floating Cart Button -->
        <a href="/cart" class="fab-cart shadow-lg animate__animated animate__bounceIn" title="View Cart">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-cart" viewBox="0 0 16 16">
                <path d="M0 1.5A.5.5 0 0 1 .5 1h1a.5.5 0 0 1 .485.379L2.89 5H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 14H4a.5.5 0 0 1-.491-.408L1.01 2H.5a.5.5 0 0 1-.5-.5zM3.102 6l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 4 0 2 2 0 0 0-4 0z"/>
            </svg>
        </a>
        {% endif %}
    </main>
    <footer class="bg-primary text-white text-center py-3 mt-5">
        &copy; {{ year }} ShopLore. All rights reserved.
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    {% block scripts %}{% endblock %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.add-to-cart-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const product = JSON.parse(this.getAttribute('data-product'));
                fetch('/add-to-cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(product)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Added to cart!');
                    } else {
                        alert(data.message || 'Failed to add to cart.');
                    }
                })
                .catch(() => alert('Error adding to cart.'));
            });
        });
        // Save user location if user is logged in and is a user
        {% if jwt_user and jwt_user['role'] == 'user' %}
        if (navigator.geolocation && !sessionStorage.getItem('locationSaved')) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                fetch('/save-location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: pos.coords.latitude, lng: pos.coords.longitude })
                }).then(res => res.json()).then(data => {
                    sessionStorage.setItem('locationSaved', '1');
                });
            });
        }
        {% endif %}
    });
    </script>
</body>
</html>
